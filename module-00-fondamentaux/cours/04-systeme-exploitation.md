# Cours 04 : Le Système d'Exploitation

## Introduction

Le système d'exploitation (OS) est l'intermédiaire entre vos programmes et le matériel. Comprendre son fonctionnement est essentiel pour la programmation système et la sécurité offensive.

---

## Rôle du Système d'Exploitation

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    COUCHES D'UN SYSTÈME                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│     ┌─────────────────────────────────────────────────────────────────┐     │
│     │                    APPLICATIONS                                  │     │
│     │         (Votre programme, navigateur, etc.)                      │     │
│     ├─────────────────────────────────────────────────────────────────┤     │
│     │                BIBLIOTHÈQUES SYSTÈME                             │     │
│     │              (libc, kernel32.dll, etc.)                          │     │
│     ├─────────────────────────────────────────────────────────────────┤     │
│     │                   APPELS SYSTÈME                                 │     │
│     │              (Interface avec le noyau)                           │     │
│     ├─────────────────────────────────────────────────────────────────┤     │
│     │                      NOYAU (KERNEL)                              │     │
│     │  ┌─────────────┐ ┌──────────────┐ ┌───────────────────────────┐ │     │
│     │  │ Gestion     │ │ Gestion      │ │ Pilotes de périphériques │ │     │
│     │  │ Processus   │ │ Mémoire      │ │ (drivers)                │ │     │
│     │  └─────────────┘ └──────────────┘ └───────────────────────────┘ │     │
│     │  ┌─────────────┐ ┌──────────────┐ ┌───────────────────────────┐ │     │
│     │  │ Système de  │ │ Réseau       │ │ Sécurité et permissions  │ │     │
│     │  │ Fichiers    │ │              │ │                          │ │     │
│     │  └─────────────┘ └──────────────┘ └───────────────────────────┘ │     │
│     ├─────────────────────────────────────────────────────────────────┤     │
│     │                       MATÉRIEL                                   │     │
│     │            (CPU, RAM, Disque, Réseau, etc.)                     │     │
│     └─────────────────────────────────────────────────────────────────┘     │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### Fonctions Principales

1. **Gestion des processus** : Créer, exécuter, terminer les programmes
2. **Gestion de la mémoire** : Allocation, protection, mémoire virtuelle
3. **Système de fichiers** : Organiser et accéder aux données
4. **Entrées/Sorties** : Gérer les périphériques
5. **Sécurité** : Permissions, isolation, authentification

---

## Les Processus

Un **processus** est un programme en cours d'exécution.

```
┌─────────────────────────────────────────────────────────────────┐
│                     ANATOMIE D'UN PROCESSUS                     │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Chaque processus possède :                                     │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                     PROCESSUS                            │    │
│  ├─────────────────────────────────────────────────────────┤    │
│  │  PID (Process ID) : Identifiant unique                  │    │
│  │  PPID : PID du processus parent                         │    │
│  │                                                          │    │
│  │  ┌─────────────────────────────────────────────────┐    │    │
│  │  │           ESPACE D'ADRESSAGE                     │    │    │
│  │  │  (Text, Data, BSS, Heap, Stack)                  │    │    │
│  │  │  → Mémoire virtuelle isolée                      │    │    │
│  │  └─────────────────────────────────────────────────┘    │    │
│  │                                                          │    │
│  │  ┌─────────────────────────────────────────────────┐    │    │
│  │  │           CONTEXTE D'EXÉCUTION                   │    │    │
│  │  │  • Valeurs des registres (EIP, ESP, etc.)       │    │    │
│  │  │  • État des flags                                │    │    │
│  │  │  • Pile noyau                                    │    │    │
│  │  └─────────────────────────────────────────────────┘    │    │
│  │                                                          │    │
│  │  ┌─────────────────────────────────────────────────┐    │    │
│  │  │              RESSOURCES                          │    │    │
│  │  │  • Fichiers ouverts (descripteurs)              │    │    │
│  │  │  • Sockets réseau                                │    │    │
│  │  │  • Privilèges et permissions                     │    │    │
│  │  │  • Variables d'environnement                     │    │    │
│  │  └─────────────────────────────────────────────────┘    │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### États d'un Processus

```
┌─────────────────────────────────────────────────────────────────┐
│                  ÉTATS D'UN PROCESSUS                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│                        ┌──────────┐                             │
│                        │ NOUVEAU  │                             │
│                        │ (créé)   │                             │
│                        └────┬─────┘                             │
│                             │ admission                         │
│                             ▼                                   │
│     interruption      ┌──────────┐      ordonnancement          │
│    ┌─────────────────│   PRÊT   │◄────────────────────┐        │
│    │                  │ (ready)  │                     │        │
│    │                  └────┬─────┘                     │        │
│    │                       │ dispatch                  │        │
│    │                       ▼                           │        │
│    │                 ┌───────────┐                     │        │
│    └────────────────►│ EXÉCUTION │─────────────────────┤        │
│                      │ (running) │                     │        │
│                      └─────┬─────┘                     │        │
│                            │                           │        │
│              ┌─────────────┼─────────────┐             │        │
│              │             │             │             │        │
│              ▼             ▼             ▼             │        │
│        ┌──────────┐  ┌──────────┐  ┌──────────┐       │        │
│        │ BLOQUÉ   │  │ TERMINÉ  │  │ SUSPENDU │       │        │
│        │(attente  │  │ (zombie) │  │          │       │        │
│        │ I/O...)  │  └──────────┘  └──────────┘       │        │
│        └────┬─────┘                                    │        │
│             │ I/O terminé                              │        │
│             └──────────────────────────────────────────┘        │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### Hiérarchie des Processus

```
┌─────────────────────────────────────────────────────────────────┐
│              ARBRE DES PROCESSUS (Linux)                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  init/systemd (PID 1)                                          │
│  ├── sshd                                                       │
│  │   └── bash                                                   │
│  │       └── vim                                                │
│  ├── cron                                                       │
│  ├── apache2                                                    │
│  │   ├── apache2 (worker)                                       │
│  │   └── apache2 (worker)                                       │
│  └── mysqld                                                     │
│                                                                 │
│  Création de processus :                                        │
│  • Linux : fork() crée une copie du processus parent           │
│  • Windows : CreateProcess() crée un nouveau processus         │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## Les Threads

Un **thread** est un fil d'exécution au sein d'un processus.

```
┌─────────────────────────────────────────────────────────────────┐
│                  PROCESSUS vs THREADS                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  PROCESSUS :                      THREADS :                     │
│                                                                 │
│  ┌────────────────────┐           ┌────────────────────┐        │
│  │ Processus A        │           │ Processus          │        │
│  │ ┌────────────────┐ │           │ ┌────┐ ┌────┐ ┌────┐│       │
│  │ │ Espace mémoire │ │           │ │ T1 │ │ T2 │ │ T3 ││       │
│  │ │ propre         │ │           │ └─┬──┘ └─┬──┘ └─┬──┘│       │
│  │ └────────────────┘ │           │   │      │      │   │       │
│  └────────────────────┘           │   └──────┼──────┘   │       │
│  ┌────────────────────┐           │          │          │       │
│  │ Processus B        │           │ ┌────────┴────────┐ │       │
│  │ ┌────────────────┐ │           │ │ Mémoire partagée│ │       │
│  │ │ Espace mémoire │ │           │ │ (code, données) │ │       │
│  │ │ propre         │ │           │ └─────────────────┘ │       │
│  │ └────────────────┘ │           └────────────────────┘        │
│  └────────────────────┘                                         │
│                                                                 │
│  Isolation complète           Mémoire partagée                  │
│  Communication via IPC        Communication directe             │
│  Coûteux à créer              Léger à créer                     │
│                                                                 │
│  Chaque thread a sa propre STACK mais partage le reste.        │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## Les Appels Système (Syscalls)

Les programmes utilisateur ne peuvent pas accéder directement au matériel. Ils doivent demander au noyau via des **appels système**.

```
┌─────────────────────────────────────────────────────────────────┐
│                    APPEL SYSTÈME                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│        Espace utilisateur                                       │
│        ┌────────────────────────────────────────────────┐       │
│        │  printf("Hello");                              │       │
│        │      │                                         │       │
│        │      ▼                                         │       │
│        │  write(1, "Hello", 5);  // libc wrapper       │       │
│        │      │                                         │       │
│        │      ▼                                         │       │
│        │  syscall instruction (int 0x80 ou syscall)    │       │
│        └────────────────────────────────────────────────┘       │
│                         │                                       │
│  ═══════════════════════╪═══════════════════════════════════    │
│        Changement       │  de mode (user → kernel)              │
│  ═══════════════════════╪═══════════════════════════════════    │
│                         ▼                                       │
│        Espace noyau                                             │
│        ┌────────────────────────────────────────────────┐       │
│        │  sys_write(fd, buffer, count)                 │       │
│        │      │                                         │       │
│        │      ▼                                         │       │
│        │  Pilote du terminal → Affichage               │       │
│        └────────────────────────────────────────────────┘       │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### Exemples de Syscalls

```
┌─────────────────────────────────────────────────────────────────┐
│               SYSCALLS COURANTS (Linux x86)                     │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Numéro   Nom         Description                               │
│  ─────────────────────────────────────────────────              │
│    1      exit        Terminer le processus                     │
│    3      read        Lire depuis un descripteur                │
│    4      write       Écrire vers un descripteur                │
│    5      open        Ouvrir un fichier                         │
│    6      close       Fermer un descripteur                     │
│   11      execve      Exécuter un programme                     │
│   45      brk         Modifier la limite du heap                │
│  102      socketcall  Opérations réseau                         │
│  120      clone       Créer un thread/processus                 │
│                                                                 │
│  Invocation directe (Linux x86) :                              │
│  ───────────────────────────────                                │
│  mov eax, 4          ; syscall number (write)                  │
│  mov ebx, 1          ; fd (stdout)                             │
│  mov ecx, message    ; buffer                                  │
│  mov edx, 13         ; length                                  │
│  int 0x80            ; appel système                           │
│                                                                 │
│  Invocation directe (Linux x64) :                              │
│  ───────────────────────────────                                │
│  mov rax, 1          ; syscall number (write)                  │
│  mov rdi, 1          ; fd (stdout)                             │
│  mov rsi, message    ; buffer                                  │
│  mov rdx, 13         ; length                                  │
│  syscall             ; appel système                           │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## Mode Utilisateur vs Mode Noyau

```
┌─────────────────────────────────────────────────────────────────┐
│                 NIVEAUX DE PRIVILÈGES                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│     Ring 0 (Noyau)                                              │
│     ┌─────────────────────────────────────────────────────┐     │
│     │  • Accès complet au matériel                        │     │
│     │  • Toutes les instructions CPU                      │     │
│     │  • Accès à toute la mémoire                         │     │
│     │  • Peut désactiver les interruptions                │     │
│     └─────────────────────────────────────────────────────┘     │
│                                                                 │
│     Ring 3 (Utilisateur)                                        │
│     ┌─────────────────────────────────────────────────────┐     │
│     │  • Pas d'accès direct au matériel                   │     │
│     │  • Instructions limitées                            │     │
│     │  • Accès uniquement à sa mémoire virtuelle          │     │
│     │  • Doit utiliser les syscalls                       │     │
│     └─────────────────────────────────────────────────────┘     │
│                                                                 │
│  Sécurité : Un programme utilisateur ne peut pas :             │
│  • Accéder à la mémoire d'un autre processus                   │
│  • Modifier le noyau                                            │
│  • Accéder directement aux périphériques                        │
│                                                                 │
│  Élévation de privilèges = passer de Ring 3 à Ring 0           │
│  C'est l'objectif de nombreux exploits !                       │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## Le Système de Fichiers

### Structure de Fichiers Linux

```
┌─────────────────────────────────────────────────────────────────┐
│              ARBORESCENCE LINUX (FHS)                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  /                        Racine                                │
│  ├── bin/                 Binaires essentiels (ls, cp...)      │
│  ├── boot/                Fichiers de démarrage                │
│  ├── dev/                 Fichiers de périphériques            │
│  │   ├── null             Puits sans fond                       │
│  │   ├── zero             Source de zéros                       │
│  │   ├── random           Générateur aléatoire                  │
│  │   └── sda              Premier disque                        │
│  ├── etc/                 Configuration système                │
│  │   ├── passwd           Utilisateurs                          │
│  │   └── shadow           Mots de passe hashés                  │
│  ├── home/                Répertoires utilisateurs              │
│  ├── lib/                 Bibliothèques partagées              │
│  ├── proc/                Système de fichiers virtuel          │
│  │   ├── [pid]/           Info sur chaque processus            │
│  │   │   ├── maps         Mappages mémoire                      │
│  │   │   ├── mem          Mémoire du processus                  │
│  │   │   └── cmdline      Ligne de commande                     │
│  │   └── self/            Lien vers le processus courant       │
│  ├── tmp/                 Fichiers temporaires                  │
│  ├── usr/                 Programmes utilisateur                │
│  └── var/                 Données variables (logs...)          │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### Descripteurs de Fichiers

```
┌─────────────────────────────────────────────────────────────────┐
│              DESCRIPTEURS DE FICHIERS                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Chaque processus a une table de descripteurs :                │
│                                                                 │
│  ┌─────┬────────────────────────────────────────┐               │
│  │ FD  │ Description                            │               │
│  ├─────┼────────────────────────────────────────┤               │
│  │  0  │ stdin  (entrée standard - clavier)    │               │
│  │  1  │ stdout (sortie standard - écran)      │               │
│  │  2  │ stderr (erreur standard - écran)      │               │
│  │  3  │ (premier fichier ouvert)              │               │
│  │  4  │ ...                                    │               │
│  └─────┴────────────────────────────────────────┘               │
│                                                                 │
│  Opérations :                                                   │
│  fd = open("/etc/passwd", O_RDONLY);  // Ouvrir               │
│  read(fd, buffer, 100);                // Lire                 │
│  write(fd, data, 50);                  // Écrire               │
│  close(fd);                            // Fermer               │
│                                                                 │
│  Redirection :                                                  │
│  $ command > output.txt    # stdout → fichier                  │
│  $ command 2>&1            # stderr → stdout                   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## Permissions et Sécurité

### Linux : Permissions UNIX

```
┌─────────────────────────────────────────────────────────────────┐
│                 PERMISSIONS UNIX                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  $ ls -la /etc/passwd                                          │
│  -rw-r--r-- 1 root root 2821 Jan 15 10:30 /etc/passwd          │
│   │││ │││ │││  │    │                                          │
│   │││ │││ │││  │    └── Groupe propriétaire                    │
│   │││ │││ │││  └─────── Utilisateur propriétaire               │
│   │││ │││ │││                                                   │
│   │││ │││ └┴┴── Autres : r-- (lecture seule)                   │
│   │││ └┴┴────── Groupe : r-- (lecture seule)                   │
│   └┴┴────────── Propriétaire : rw- (lecture/écriture)          │
│                                                                 │
│  Permissions :                                                  │
│  r (read)    = 4   Lecture                                     │
│  w (write)   = 2   Écriture                                    │
│  x (execute) = 1   Exécution                                   │
│                                                                 │
│  chmod 755 script.sh   # rwxr-xr-x                             │
│  chmod 644 file.txt    # rw-r--r--                             │
│                                                                 │
│  Permissions spéciales :                                        │
│  SUID (4000) : Exécuter avec les droits du propriétaire       │
│  SGID (2000) : Exécuter avec les droits du groupe             │
│  Sticky (1000) : Seul le propriétaire peut supprimer          │
│                                                                 │
│  SUID root = DANGER : le programme tourne en root !           │
│  Cible privilégiée pour l'élévation de privilèges             │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### Windows : ACL

```
┌─────────────────────────────────────────────────────────────────┐
│                    SÉCURITÉ WINDOWS                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Windows utilise des ACL (Access Control Lists) plus          │
│  détaillées que UNIX.                                          │
│                                                                 │
│  Concepts clés :                                                │
│  • SID : Security Identifier (identifiant unique)              │
│  • Token : Contient les privilèges de l'utilisateur           │
│  • ACE : Access Control Entry (une permission)                 │
│  • DACL : Discretionary ACL (permissions)                      │
│  • SACL : System ACL (audit)                                   │
│                                                                 │
│  Groupes importants :                                           │
│  • SYSTEM : Le système lui-même (plus puissant qu'admin)       │
│  • Administrators : Administrateurs locaux                      │
│  • Users : Utilisateurs normaux                                 │
│                                                                 │
│  Privilèges importants :                                        │
│  • SeDebugPrivilege : Débugger n'importe quel processus       │
│  • SeImpersonatePrivilege : Usurper l'identité                │
│  • SeBackupPrivilege : Lire n'importe quel fichier            │
│                                                                 │
│  Ces privilèges sont des cibles pour l'élévation !             │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## Communication Inter-Processus (IPC)

```
┌─────────────────────────────────────────────────────────────────┐
│                      MÉTHODES IPC                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  PIPES (Tubes)                                                  │
│  ─────────────                                                  │
│  Communication unidirectionnelle parent→enfant                 │
│  $ ls | grep ".txt"                                            │
│                                                                 │
│  NAMED PIPES (FIFO)                                             │
│  ─────────────────                                              │
│  Comme pipes mais avec un nom dans le système de fichiers     │
│  mkfifo /tmp/myfifo                                            │
│                                                                 │
│  SHARED MEMORY                                                  │
│  ─────────────                                                  │
│  Zone de mémoire partagée entre processus                      │
│  Plus rapide mais nécessite synchronisation                    │
│                                                                 │
│  SOCKETS                                                        │
│  ───────                                                        │
│  Communication réseau (même sur localhost)                     │
│  TCP/UDP, Unix domain sockets                                  │
│                                                                 │
│  SIGNALS                                                        │
│  ───────                                                        │
│  Notifications asynchrones (SIGTERM, SIGKILL...)               │
│                                                                 │
│  MESSAGE QUEUES / SEMAPHORES                                   │
│  ──────────────────────────                                     │
│  Synchronisation et échange de messages                        │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## Pertinence pour la Sécurité Offensive

### Élévation de Privilèges

```
┌─────────────────────────────────────────────────────────────────┐
│              VECTEURS D'ÉLÉVATION                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Linux :                                                        │
│  • Binaires SUID mal configurés                                │
│  • Vulnérabilités kernel                                       │
│  • Permissions fichiers trop permissives                       │
│  • Cron jobs exécutés en root                                  │
│  • sudo mal configuré                                           │
│  • Capabilities sur des binaires                               │
│                                                                 │
│  Windows :                                                       │
│  • Services mal configurés                                      │
│  • DLL hijacking                                                │
│  • Tokens et privilèges                                         │
│  • UAC bypass                                                   │
│  • Vulnérabilités kernel                                       │
│  • Scheduled tasks                                              │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### Injection et Manipulation

```
┌─────────────────────────────────────────────────────────────────┐
│              TECHNIQUES D'INJECTION                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Injection de code dans un processus :                         │
│                                                                 │
│  Linux :                                                        │
│  • ptrace() pour attacher à un processus                       │
│  • /proc/[pid]/mem pour lire/écrire la mémoire                │
│  • LD_PRELOAD pour charger des bibliothèques                   │
│                                                                 │
│  Windows :                                                       │
│  • CreateRemoteThread()                                         │
│  • WriteProcessMemory()                                         │
│  • DLL Injection                                                │
│  • Process Hollowing                                            │
│  • APC Injection                                                │
│                                                                 │
│  Ces techniques seront détaillées dans les modules avancés.    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## Résumé

```
┌─────────────────────────────────────────────────────────────────┐
│                        POINTS CLÉS                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  • L'OS est l'intermédiaire entre programmes et matériel       │
│                                                                 │
│  • Processus = programme en exécution avec son espace mémoire  │
│                                                                 │
│  • Les syscalls sont l'interface avec le noyau                 │
│                                                                 │
│  • Ring 0 (noyau) vs Ring 3 (utilisateur)                      │
│    → L'élévation de privilèges = passer au Ring 0              │
│                                                                 │
│  • Permissions UNIX (rwx) et SUID sont des cibles classiques   │
│                                                                 │
│  • /proc contient des informations précieuses sur les          │
│    processus (Linux)                                            │
│                                                                 │
│  • Comprendre l'OS = comprendre ce qu'on peut exploiter        │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## Navigation

| Précédent | Suivant |
|-----------|---------|
| [03 - La Mémoire](03-memoire.md) | [05 - Du Code à l'Exécution](05-code-a-execution.md) |
